"use strict";(()=>{var Y=Object.create;var F=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var ee=Object.getPrototypeOf,te=Object.prototype.hasOwnProperty;var ne=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var ie=(t,e,n,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of q(e))!te.call(t,o)&&o!==n&&F(t,o,{get:()=>e[o],enumerable:!(i=Q(e,o))||i.enumerable});return t};var se=(t,e,n)=>(n=t!=null?Y(ee(t)):{},ie(e||!t||!t.__esModule?F(n,"default",{value:t,enumerable:!0}):n,t));var P=ne((Te,B)=>{"use strict";var re=Object.prototype.hasOwnProperty,d="~";function y(){}Object.create&&(y.prototype=Object.create(null),new y().__proto__||(d=!1));function oe(t,e,n){this.fn=t,this.context=e,this.once=n||!1}function H(t,e,n,i,o){if(typeof n!="function")throw new TypeError("The listener must be a function");var a=new oe(n,i||t,o),r=d?d+e:e;return t._events[r]?t._events[r].fn?t._events[r]=[t._events[r],a]:t._events[r].push(a):(t._events[r]=a,t._eventsCount++),t}function S(t,e){--t._eventsCount===0?t._events=new y:delete t._events[e]}function u(){this._events=new y,this._eventsCount=0}u.prototype.eventNames=function(){var e=[],n,i;if(this._eventsCount===0)return e;for(i in n=this._events)re.call(n,i)&&e.push(d?i.slice(1):i);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(n)):e};u.prototype.listeners=function(e){var n=d?d+e:e,i=this._events[n];if(!i)return[];if(i.fn)return[i.fn];for(var o=0,a=i.length,r=new Array(a);o<a;o++)r[o]=i[o].fn;return r};u.prototype.listenerCount=function(e){var n=d?d+e:e,i=this._events[n];return i?i.fn?1:i.length:0};u.prototype.emit=function(e,n,i,o,a,r){var h=d?d+e:e;if(!this._events[h])return!1;var s=this._events[h],l=arguments.length,p,m;if(s.fn){switch(s.once&&this.removeListener(e,s.fn,void 0,!0),l){case 1:return s.fn.call(s.context),!0;case 2:return s.fn.call(s.context,n),!0;case 3:return s.fn.call(s.context,n,i),!0;case 4:return s.fn.call(s.context,n,i,o),!0;case 5:return s.fn.call(s.context,n,i,o,a),!0;case 6:return s.fn.call(s.context,n,i,o,a,r),!0}for(m=1,p=new Array(l-1);m<l;m++)p[m-1]=arguments[m];s.fn.apply(s.context,p)}else{var M=s.length,v;for(m=0;m<M;m++)switch(s[m].once&&this.removeListener(e,s[m].fn,void 0,!0),l){case 1:s[m].fn.call(s[m].context);break;case 2:s[m].fn.call(s[m].context,n);break;case 3:s[m].fn.call(s[m].context,n,i);break;case 4:s[m].fn.call(s[m].context,n,i,o);break;default:if(!p)for(v=1,p=new Array(l-1);v<l;v++)p[v-1]=arguments[v];s[m].fn.apply(s[m].context,p)}}return!0};u.prototype.on=function(e,n,i){return H(this,e,n,i,!1)};u.prototype.once=function(e,n,i){return H(this,e,n,i,!0)};u.prototype.removeListener=function(e,n,i,o){var a=d?d+e:e;if(!this._events[a])return this;if(!n)return S(this,a),this;var r=this._events[a];if(r.fn)r.fn===n&&(!o||r.once)&&(!i||r.context===i)&&S(this,a);else{for(var h=0,s=[],l=r.length;h<l;h++)(r[h].fn!==n||o&&!r[h].once||i&&r[h].context!==i)&&s.push(r[h]);s.length?this._events[a]=s.length===1?s[0]:s:S(this,a)}return this};u.prototype.removeAllListeners=function(e){var n;return e?(n=d?d+e:e,this._events[n]&&S(this,n)):(this._events=new y,this._eventsCount=0),this};u.prototype.off=u.prototype.removeListener;u.prototype.addListener=u.prototype.on;u.prefixed=d;u.EventEmitter=u;typeof B<"u"&&(B.exports=u)});var U=se(P());function O(t){for(;t.childElementCount>0;)t.removeChild(t.children[0])}function W(t,e,n,i,o,a,r=0){let h=t.measureText(e),s=h.actualBoundingBoxAscent+h.actualBoundingBoxDescent+r*2,l=h.actualBoundingBoxLeft+h.actualBoundingBoxRight+r*2;t.fillStyle=a,t.fillRect(n,i,l,s),t.strokeStyle=o,t.strokeText(e,n+r,i+h.actualBoundingBoxAscent+r)}function c(t,e={}){let n=document.createElement(t);return Object.assign(n,e),n}var b=class{constructor(e,n){this.element=e;this.callback=n;this.active=!1,this.x=NaN,this.y=NaN,e.style.cursor="grab",e.addEventListener("mousedown",this.down.bind(this)),e.addEventListener("mouseup",this.up.bind(this)),e.addEventListener("mousemove",this.move.bind(this))}down(e){this.element.style.cursor="grabbing",this.active=!0,this.x=e.x,this.y=e.y}up(){this.element.style.cursor="grab",this.active=!1}move(e){if(this.active){let n=e.x-this.x,i=e.y-this.y;this.callback(n,i),this.x=e.x,this.y=e.y}}};var g=class{constructor(e,n){this.name=e;this.fn=n}soon(){this.handle||(this.handle=requestAnimationFrame(()=>{this.handle=void 0,this.fn()}))}cancel(){this.handle&&(cancelAnimationFrame(this.handle),this.handle=void 0)}};function R(t,e,n){return Math.max(Math.min(t,n),e)}function I(t){return Math.floor(t)===t}function j(t){let{width:e,height:n}=t.layout;if(e<8||n<8)return[];let i=[];for(let o=0,a=0;a<t.size.height;o++,a+=n)for(let r=0,h=0;h<t.size.width;r++,h+=e)i.push({id:`${r},${o}`,x:h,y:a,width:e,height:n});return i}var w=class{constructor(e){this.ui=e;this.ox=0,this.oy=0,this.z=1,this.redraw=new g("ImageViewer",()=>this.draw()),this.canvas=c("canvas",{className:"image"}),this.dragListener=new b(this.canvas,(i,o)=>this.onDrag(i,o)),this.canvas.addEventListener("wheel",i=>this.onZoom(i.deltaMode,i.deltaY)),e.main.append(this.canvas);let n=this.canvas.getContext("2d");if(!n)throw new Error("Could not get 2D context");this.ctx=n,e.on("open",i=>this.show(i)),e.on("tagLoaded",i=>this.useTag(i)),window.addEventListener("resize",()=>this.onResize()),this.onResize()}onDrag(e,n){this.ox+=e,this.oy+=n,this.redraw.soon()}onResize(){this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.redraw.soon()}onZoom(e,n){if(e===WheelEvent.DOM_DELTA_PIXEL){let i=n/-500;this.z=R(this.z+i,.2,3),this.redraw.soon()}}show(e){this.ui.db.get("files",e).then(n=>{n?.type==="sprite"&&this.load(n.data)})}useTag(e){this.tag=e,this.redraw.soon()}async load(e){this.img=await createImageBitmap(e),this.ui.emit("imageLoaded",this.img),this.ox=0,this.oy=0,this.z=1,this.redraw.soon()}transform(e,n){return[e*this.z+this.ox,n*this.z+this.oy]}transformSize(e,n){return[e*this.z,n*this.z]}draw(){let{ctx:e,img:n,tag:i}=this;if(e.clearRect(0,0,this.canvas.width,this.canvas.height),e.imageSmoothingEnabled=!1,!n)return;let[o,a]=this.transform(0,0),[r,h]=this.transformSize(n.width,n.height);if(e.drawImage(n,o,a,r,h),i)for(let s of j(i)){let[l,p]=this.transform(s.x,s.y),[m,M]=this.transformSize(s.width,s.height);e.strokeStyle="red",e.strokeRect(l,p,m,M),W(e,s.id,l,p,"white","red",4)}}};var x=class{constructor(e){this.ui=e;this.container=c("div",{className:"files"}),e.nav.append(this.container),e.on("fileAdded",this.refresh.bind(this)),this.refresh()}refresh(){this.ui.db.getAll("files").then(e=>{O(this.container);for(let n of e)this.container.append(this.getFile(n))})}getFile(e){let n=c("button",{innerText:e.name});return n.addEventListener("click",()=>this.ui.emit("open",e.name)),e.type!=="sprite"&&(n.disabled=!0),n}};function ae(t){return t+".tag.json"}var T=class{constructor(e){this.ui=e;this.refresh=new g("Toolbar",()=>this.draw()),this.container=c("div",{className:"toolbar"}),e.main.append(this.container),this.save=c("button",{innerText:"Save"}),this.save.addEventListener("click",()=>this.saveTag()),this.container.append(this.save),this.meta=c("div",{className:"toolbar-meta"}),this.container.append(this.meta),this.meta.append(c("span",{innerText:"Size:"})),this.size=c("span",{innerText:"-"}),this.meta.append(this.size),this.meta.append(c("span",{innerText:"Tiles:"})),this.tiles=c("span",{innerText:"-"}),this.meta.append(this.tiles),this.meta.append(c("label",{innerText:"Tile Width",htmlFor:"tile-width"})),this.width=c("input",{id:"tile-width",type:"number",min:"1"}),this.width.addEventListener("change",()=>this.onChangeSize()),this.meta.append(this.width),this.meta.append(c("label",{innerText:"Tile Height",htmlFor:"tile-height"})),this.height=c("input",{id:"tile-height",type:"number",min:"1"}),this.height.addEventListener("change",()=>this.onChangeSize()),this.meta.append(this.height),this.imageWidth=NaN,this.imageHeight=NaN,e.on("imageLoaded",n=>this.useImage(n)),e.on("open",n=>this.loadTag(n))}loadTag(e){let n=ae(e);this.ui.db.get("files",n).then(i=>(this.tagName=n,i?i.data.text().then(o=>JSON.parse(o)):{file:e,size:{width:0,height:0},layout:{type:"grid",width:1,height:1},tags:{},animations:{}})).then(i=>this.useTag(i))}useImage(e){let{width:n,height:i}=e;this.img=e,this.imageWidth=n,this.imageHeight=i,this.tag&&(this.tag.size={width:n,height:i}),this.refresh.soon()}useTag(e){if(this.tag=e,this.width.valueAsNumber=e.layout.width,this.height.valueAsNumber=e.layout.height,this.img){let{width:n,height:i}=this.img;this.tag.size={width:n,height:i}}this.refresh.soon(),this.ui.emit("tagLoaded",e)}onChangeSize(){!this.tag||(this.tag.layout.width=this.width.valueAsNumber,this.tag.layout.height=this.height.valueAsNumber,this.ui.emit("tagLoaded",this.tag),this.refresh.soon())}draw(){this.size.innerText=`${this.imageWidth}x${this.imageHeight}`;let e=this.imageWidth/this.width.valueAsNumber,n=this.imageHeight/this.height.valueAsNumber;this.tiles.innerText=`${e}x${n}`,this.tiles.style.color=I(e)&&I(n)?"":"red"}saveTag(){if(!this.tagName||!this.tag)return;let e={name:this.tagName,type:"sprite-tag",data:new File([JSON.stringify(this.tag)],this.tagName,{type:"application/json"})};this.ui.db.put("files",e).then(n=>this.ui.emit("fileAdded",n))}};function he(t,e){switch(e){case"image/png":return"sprite"}}var E=class{constructor(e){this.ui=e;this.container=c("div"),e.nav.append(this.container),this.input=c("input",{type:"file"}),this.container.append(this.input),this.input.addEventListener("change",this.addFiles.bind(this))}addFiles(){let e=[];for(let n of this.input.files||[]){let{name:i,type:o}=n,a=he(i,o);if(!a){console.error("Unknown file type:",n);continue}e.push({name:i,type:a,data:n})}Promise.all(e.map(n=>this.ui.db.add("files",n))).then(n=>{for(let i of n)this.ui.emit("fileAdded",i);this.input.value=""})}};var L=class extends U.default{constructor(n){super();this.db=n;this.body=document.body,this.nav=c("nav"),this.body.append(this.nav),this.main=c("main"),this.body.append(this.main),this.uploader=new E(this),this.repository=new x(this),this.toolbar=new T(this),this.image=new w(this)}};var ce=(t,e)=>e.some(n=>t instanceof n),K,$;function me(){return K||(K=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function le(){return $||($=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var V=new WeakMap,A=new WeakMap,G=new WeakMap,N=new WeakMap,z=new WeakMap;function ue(t){let e=new Promise((n,i)=>{let o=()=>{t.removeEventListener("success",a),t.removeEventListener("error",r)},a=()=>{n(f(t.result)),o()},r=()=>{i(t.error),o()};t.addEventListener("success",a),t.addEventListener("error",r)});return e.then(n=>{n instanceof IDBCursor&&V.set(n,t)}).catch(()=>{}),z.set(e,t),e}function de(t){if(A.has(t))return;let e=new Promise((n,i)=>{let o=()=>{t.removeEventListener("complete",a),t.removeEventListener("error",r),t.removeEventListener("abort",r)},a=()=>{n(),o()},r=()=>{i(t.error||new DOMException("AbortError","AbortError")),o()};t.addEventListener("complete",a),t.addEventListener("error",r),t.addEventListener("abort",r)});A.set(t,e)}var C={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return A.get(t);if(e==="objectStoreNames")return t.objectStoreNames||G.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return f(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function J(t){C=t(C)}function pe(t){return t===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...n){let i=t.call(D(this),e,...n);return G.set(i,e.sort?e.sort():[e]),f(i)}:le().includes(t)?function(...e){return t.apply(D(this),e),f(V.get(this))}:function(...e){return f(t.apply(D(this),e))}}function fe(t){return typeof t=="function"?pe(t):(t instanceof IDBTransaction&&de(t),ce(t,me())?new Proxy(t,C):t)}function f(t){if(t instanceof IDBRequest)return ue(t);if(N.has(t))return N.get(t);let e=fe(t);return e!==t&&(N.set(t,e),z.set(e,t)),e}var D=t=>z.get(t);function X(t,e,{blocked:n,upgrade:i,blocking:o,terminated:a}={}){let r=indexedDB.open(t,e),h=f(r);return i&&r.addEventListener("upgradeneeded",s=>{i(f(r.result),s.oldVersion,s.newVersion,f(r.transaction))}),n&&r.addEventListener("blocked",()=>n()),h.then(s=>{a&&s.addEventListener("close",()=>a()),o&&s.addEventListener("versionchange",()=>o())}).catch(()=>{}),h}var ge=["get","getKey","getAll","getAllKeys","count"],ve=["put","add","delete","clear"],_=new Map;function Z(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(_.get(e))return _.get(e);let n=e.replace(/FromIndex$/,""),i=e!==n,o=ve.includes(n);if(!(n in(i?IDBIndex:IDBObjectStore).prototype)||!(o||ge.includes(n)))return;let a=async function(r,...h){let s=this.transaction(r,o?"readwrite":"readonly"),l=s.store;return i&&(l=l.index(h.shift())),(await Promise.all([l[n](...h),o&&s.done]))[0]};return _.set(e,a),a}J(t=>({...t,get:(e,n,i)=>Z(e,n)||t.get(e,n,i),has:(e,n)=>!!Z(e,n)||t.has(e,n)}));async function k(){return X("sprite-tagger",1,{upgrade(t,e){e<1&&t.createObjectStore("files",{keyPath:"name"})}})}function ye(){k().then(t=>{window.ui=new L(t)}).catch(t=>{console.error("Could not open database:",t)})}window.addEventListener("load",ye);})();
//# sourceMappingURL=build.js.map
